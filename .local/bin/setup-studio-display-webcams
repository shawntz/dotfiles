#!/usr/bin/env bash
# Configure Apple Studio Display webcams for optimal quality

echo "Configuring Apple Studio Display webcams for optimal quality..."

# Find all Studio Display webcams
STUDIO_CAMS=$(v4l2-ctl --list-devices | grep -A1 "Studio Display" | grep "/dev/video" | head -2)

for cam in $STUDIO_CAMS; do
  if [[ -e "$cam" ]]; then
    echo "Configuring $cam..."

    # Set to 1080p 30fps MJPEG for best quality
    v4l2-ctl -d "$cam" --set-fmt-video=width=1920,height=1080,pixelformat=MJPG 2>/dev/null

    # Set exposure and white balance to auto
    v4l2-ctl -d "$cam" --set-ctrl=auto_exposure=0 2>/dev/null # Auto Mode
    v4l2-ctl -d "$cam" --set-ctrl=white_balance_automatic=1 2>/dev/null

    # Set power line frequency to 60Hz (US standard)
    v4l2-ctl -d "$cam" --set-ctrl=power_line_frequency=2 2>/dev/null

    # Center the camera (reset pan/tilt)
    v4l2-ctl -d "$cam" --set-ctrl=pan_absolute=0 2>/dev/null
    v4l2-ctl -d "$cam" --set-ctrl=tilt_absolute=-2880000 2>/dev/null # Default tilt

    # Set zoom to a natural level (slightly zoomed in from minimum)
    v4l2-ctl -d "$cam" --set-ctrl=zoom_absolute=150 2>/dev/null

    echo "  Set to 1920x1080 30fps MJPEG"
  fi
done

echo "Studio Display webcam configuration complete!"
echo ""
echo "Current settings:"
for cam in $STUDIO_CAMS; do
  if [[ -e "$cam" ]]; then
    echo "$cam:"
    v4l2-ctl -d "$cam" --get-fmt-video | grep -E "Width|Pixel"
    echo ""
  fi
done
